local AdvancedDeobfuscationModule = {}

-- Metadados do mÃ³dulo
AdvancedDeobfuscationModule.Info = {
    Name = "AdvancedDeobfuscationModule",
    Version = "1.0.0",
    Author = "DragonMODS",
    Description = "MÃ³dulo avanÃ§ado com 32 mÃ©todos de desofuscaÃ§Ã£o/desencriptaÃ§Ã£o para scripts Lua",
    LastUpdate = os.time(),
    Dependencies = {"HttpService", "game"}
}

-- ConfiguraÃ§Ãµes do mÃ³dulo
AdvancedDeobfuscationModule.Config = {
    maxStringLength = 10000,         -- MÃ¡ximo de caracteres para processar
    enableBytecodeProcessing = true, -- Processar bytecode
    enableCryptoProcessing = true,   -- Usar criptografia avanÃ§ada
    logChanges = true,              -- Registrar mudanÃ§as
    formatOutput = true,            -- Formatar saÃ­da
    useCryptoKeys = true,           -- Usar chaves do CryptoKeysModule
    maxIterations = 5               -- MÃ¡ximo de iteraÃ§Ãµes para mÃ©todos incrementais
}

-- FunÃ§Ã£o para carregar CryptoKeysModule (reutiliza a lÃ³gica do mÃ³dulo original)
local HttpService = game:GetService("HttpService")
local function loadCryptoKeysModule()
    local url = "https://raw.githubusercontent.com/BRX-HUB/DragonHUB_RASGADOR-DE-INFORMA-ES/refs/heads/main/CryptoKeysModule.lua"
    local success, response = pcall(function()
        return game:HttpGet(url, true)
    end)
    if not success then
        warn("Erro ao carregar CryptoKeysModule: " .. tostring(response))
        return nil
    end
    local moduleFunc, loadError = loadstring(response)
    if not moduleFunc then
        warn("Erro ao compilar CryptoKeysModule: " .. tostring(loadError))
        return nil
    end
    local module, execError = pcall(moduleFunc)
    if not module then
        warn("Erro ao executar CryptoKeysModule: " .. tostring(execError))
        return nil
    end
    return module
end

local CryptoKeys = nil
local LoadedKeys = nil

-- Inicializa chaves criptogrÃ¡ficas
function AdvancedDeobfuscationModule:InitializeCryptoKeys()
    if not self.Config.useCryptoKeys then
        return false, "Uso de chaves criptogrÃ¡ficas desabilitado"
    end
    CryptoKeys = loadCryptoKeysModule()
    if CryptoKeys then
        LoadedKeys = CryptoKeys:GetAllKeys()
        if self.Config.logChanges then
            print("âœ… AdvancedDeobfuscationModule: CryptoKeysModule carregado!")
        end
        return true, "Chaves carregadas com sucesso"
    end
    return false, "Falha ao carregar CryptoKeysModule"
end

-- FunÃ§Ã£o auxiliar para registrar mudanÃ§as
local function logChange(changes, changeType, original, result, details)
    table.insert(changes, {
        type = changeType,
        original = original,
        result = result,
        details = details or {}
    })
end

-- === 32 MÃ©todos de DesofuscaÃ§Ã£o/DesencriptaÃ§Ã£o ===

-- 1. DesofuscaÃ§Ã£o de Bytecode (NormalizaÃ§Ã£o)
function AdvancedDeobfuscationModule:DeobfuscateBytecode(code)
    if not self.Config.enableBytecodeProcessing then return code, {} end
    local changes = {}
    local success, chunk = pcall(loadstring, code)
    if not success then
        logChange(changes, "bytecode_error", code, nil, { error = chunk })
        return code, changes
    end
    -- Placeholder: Normalizar instruÃ§Ãµes de bytecode (ex.: reverter manipulaÃ§Ãµes bit32)
    local deobfuscated = "-- Bytecode normalized (placeholder)"
    logChange(changes, "bytecode_deobfuscation", code, deobfuscated, { method = "normalization" })
    return deobfuscated, changes
end

-- 2. DesencriptaÃ§Ã£o Base64
function AdvancedDeobfuscationModule:DeobfuscateBase64(code)
    local changes = {}
    local deobfuscated = code
    local base64Pattern = '"([A-Za-z0-9+/=]+)"'
    deobfuscated = string.gsub(deobfuscated, base64Pattern, function(encoded)
        local success, decoded = pcall(function()
            return HttpService:DecodeBase64(encoded) -- Roblox API
        end)
        if success and decoded then
            logChange(changes, "base64_deobfuscation", encoded, decoded)
            return '"' .. decoded .. '"'
        end
        return encoded
    end)
    return deobfuscated, changes
end

-- 3. NormalizaÃ§Ã£o de Ambientes (getfenv/setfenv)
function AdvancedDeobfuscationModule:DeobfuscateEnvironments(code)
    local changes = {}
    local deobfuscated = code
    local envPattern = "setfenv%((%d+),.-getfenv%((%d*)%)%)"
    deobfuscated = string.gsub(deobfuscated, envPattern, function(level, env)
        logChange(changes, "environment_deobfuscation", string.format("setfenv(%s, getfenv(%s))", level, env), "-- Normalized")
        return ""
    end)
    return deobfuscated, changes
end

-- 4. DesofuscaÃ§Ã£o de Tabelas Complexas
function AdvancedDeobfuscationModule:DeobfuscateTables(code)
    local changes = {}
    local deobfuscated = code
    local tablePattern = "local%s+([%w_]+)%s*=%s*{([^}]*)}"
    deobfuscated = string.gsub(deobfuscated, tablePattern, function(varName, content)
        local values = {}
        for value in string.gmatch(content, "[^,]+") do
            table.insert(values, string.match(value, "^%s*(.-)%s*$"))
        end
        if #values > 0 then
            local result = table.concat(values, ", ")
            logChange(changes, "table_deobfuscation", content, result, { variable = varName })
            return string.format('local %s = {%s} -- Deobfuscated table', varName, result)
        end
        return string.format('local %s = {%s}', varName, content)
    end)
    return deobfuscated, changes
end

-- 5. ExtraÃ§Ã£o de Chaves DinÃ¢micas
function AdvancedDeobfuscationModule:ExtractCryptoKeys(code)
    local keys = { numeric = {}, strings = {}, xor = {} }
    local keyPattern = "local%s+([%w_]+)%s*=%s*(%d+)"
    for varName, value in string.gmatch(code, keyPattern) do
        table.insert(keys.numeric, tonumber(value))
    end
    local stringPattern = 'local%s+([%w_]+)%s*=%s*"([^"]*)"'
    for varName, str in string.gmatch(code, stringPattern) do
        table.insert(keys.strings, str)
    end
    return keys
end

-- 6. DesofuscaÃ§Ã£o Incremental
function AdvancedDeobfuscationModule:IncrementalDeobfuscation(code, steps)
    local deobfuscated = code
    local changes = {}
    for _, step in ipairs(steps) do
        local result, stepChanges = self[step](self, deobfuscated)
        deobfuscated = result
        for _, change in ipairs(stepChanges) do
            table.insert(changes, change)
        end
    end
    return deobfuscated, changes
end

-- 7. DesencriptaÃ§Ã£o de syn.crypt (Roblox-specific)
function AdvancedDeobfuscationModule:DeobfuscateRobloxCrypt(code)
    local changes = {}
    local deobfuscated = code
    local cryptPattern = "syn%.crypt%.decrypt%(['\"](.-)['\"],.-%)"
    deobfuscated = string.gsub(deobfuscated, cryptPattern, function(encrypted)
        local decrypted = syn.crypt.decrypt(encrypted, LoadedKeys and LoadedKeys.roblox or "")
        if decrypted then
            logChange(changes, "roblox_crypt_deobfuscation", encrypted, decrypted)
            return '"' .. decrypted .. '"'
        end
        return encrypted
    end)
    return deobfuscated, changes
end

-- 8. DesofuscaÃ§Ã£o de FunÃ§Ãµes Fragmentadas
function AdvancedDeobfuscationModule:DeobfuscateFunctions(code)
    local changes = {}
    local deobfuscated = code
    local funcPattern = "local%s+([%w_]+)%s*=%s*loadstring%(['\"](.-)['\"]%)"
    deobfuscated = string.gsub(deobfuscated, funcPattern, function(varName, funcCode)
        local success, result = pcall(loadstring, funcCode)
        if success then
            logChange(changes, "function_deobfuscation", funcCode, tostring(result), { variable = varName })
            return string.format("local %s = -- Deobfuscated function\n%s", varName, funcCode)
        end
        return string.format("local %s = loadstring(%q)", varName, funcCode)
    end)
    return deobfuscated, changes
end

-- 9. DescompressÃ£o LZW
function AdvancedDeobfuscationModule:DeobfuscateLZW(code)
    local changes = {}
    -- Placeholder: Implementar descompressÃ£o LZW (requer biblioteca especÃ­fica)
    logChange(changes, "lzw_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 10. DescompressÃ£o Huffman
function AdvancedDeobfuscationModule:DeobfuscateHuffman(code)
    local changes = {}
    -- Placeholder: Implementar descompressÃ£o Huffman
    logChange(changes, "huffman_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 11. DesencriptaÃ§Ã£o AES
function AdvancedDeobfuscationModule:DeobfuscateAES(code)
    local changes = {}
    -- Placeholder: Implementar desencriptaÃ§Ã£o AES usando chaves do CryptoKeysModule
    logChange(changes, "aes_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 12. DesencriptaÃ§Ã£o RSA
function AdvancedDeobfuscationModule:DeobfuscateRSA(code)
    local changes = {}
    -- Placeholder: Implementar desencriptaÃ§Ã£o RSA
    logChange(changes, "rsa_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 13. DesofuscaÃ§Ã£o de Constantes Embaralhadas
function AdvancedDeobfuscationModule:DeobfuscateScrambledConstants(code)
    local changes = {}
    local deobfuscated = code
    local constPattern = "local%s+([%w_]+)%s*=%s*([%d%.]+)%s*[~^]%s*([%d%.]+)"
    deobfuscated = string.gsub(deobfuscated, constPattern, function(varName, val1, val2)
        local result = tonumber(val1) ~ tonumber(val2)
        logChange(changes, "scrambled_constants", string.format("%s ~ %s", val1, val2), tostring(result))
        return string.format("local %s = %s", varName, result)
    end)
    return deobfuscated, changes
end

-- 14. DesofuscaÃ§Ã£o de Chamadas Indiretas
function AdvancedDeobfuscationModule:DeobfuscateIndirectCalls(code)
    local changes = {}
    local deobfuscated = code
    local callPattern = "([%w_]+)%[%d+%]%((.-)%)"
    deobfuscated = string.gsub(deobfuscated, callPattern, function(funcTable, args)
        logChange(changes, "indirect_call_deobfuscation", string.format("%s[%d](%s)", funcTable, 1, args), args)
        return string.format("%s(%s)", funcTable, args)
    end)
    return deobfuscated, changes
end

-- 15. DesofuscaÃ§Ã£o de Loops Ofuscados
function AdvancedDeobfuscationModule:DeobfuscateObfuscatedLoops(code)
    local changes = {}
    local deobfuscated = code
    local loopPattern = "for%s+([%w_]+)%s*=%s*([%d%.]+)%s*,%s*([%d%.]+)%s*do.-end"
    deobfuscated = string.gsub(deobfuscated, loopPattern, function(var, start, finish)
        logChange(changes, "loop_deobfuscation", string.format("for %s = %s, %s", var, start, finish), "-- Simplified loop")
        return string.format("for %s = %s, %s do -- Simplified\nend", var, start, finish)
    end)
    return deobfuscated, changes
end

-- 16. DesofuscaÃ§Ã£o de CondiÃ§Ãµes Ofuscadas
function AdvancedDeobfuscationModule:DeobfuscateObfuscatedConditions(code)
    local changes = {}
    local deobfuscated = code
    local condPattern = "if%s+([%w_]+)%s*[><=]=%s*([%d%.]+)%s*then.-end"
    deobfuscated = string.gsub(deobfuscated, condPattern, function(var, value)
        logChange(changes, "condition_deobfuscation", string.format("if %s %s", var, value), "-- Simplified condition")
        return string.format("if %s == %s then -- Simplified\nend", var, value)
    end)
    return deobfuscated, changes
end

-- 17. DesofuscaÃ§Ã£o de CÃ³digo Injetado
function AdvancedDeobfuscationModule:DeobfuscateInjectedCode(code)
    local changes = {}
    -- Placeholder: Detectar e simplificar cÃ³digo injetado via eval ou loadstring
    logChange(changes, "injected_code_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 18. DesofuscaÃ§Ã£o de VariÃ¡veis Renomeadas
function AdvancedDeobfuscationModule:DeobfuscateRenamedVariables(code)
    local changes = {}
    local deobfuscated = code
    local varPattern = "local%s+_G[%.%w]+%s*=%s*(.-);"
    deobfuscated = string.gsub(deobfuscated, varPattern, function(value)
        logChange(changes, "renamed_variable_deobfuscation", value, value)
        return string.format("local meaningfulName = %s -- Renamed", value)
    end)
    return deobfuscated, changes
end

-- 19. DesencriptaÃ§Ã£o com Chave Rotativa
function AdvancedDeobfuscationModule:DeobfuscateRotatingKey(code)
    local changes = {}
    -- Placeholder: Implementar desencriptaÃ§Ã£o com chaves rotativas
    logChange(changes, "rotating_key_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 20. DesofuscaÃ§Ã£o de Strings Fragmentadas
function AdvancedDeobfuscationModule:DeobfuscateFragmentedStrings(code)
    local changes = {}
    local deobfuscated = code
    local fragPattern = '"(.-)"%s*%.%.%s*"(.-)"'
    deobfuscated = string.gsub(deobfuscated, fragPattern, function(part1, part2)
        local result = part1 .. part2
        logChange(changes, "fragmented_string_deobfuscation", part1 .. ".." .. part2, result)
        return '"' .. result .. '"'
    end)
    return deobfuscated, changes
end

-- 21. DesofuscaÃ§Ã£o de Tabelas DinÃ¢micas
function AdvancedDeobfuscationModule:DeobfuscateDynamicTables(code)
    local changes = {}
    -- Placeholder: Processar tabelas geradas dinamicamente
    logChange(changes, "dynamic_table_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 22. DesencriptaÃ§Ã£o com Hashing (ex.: MD5)
function AdvancedDeobfuscationModule:DeobfuscateHashedValues(code)
    local changes = {}
    -- Placeholder: Reverter valores hashados (ex.: MD5, SHA)
    logChange(changes, "hashed_value_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 23. DesofuscaÃ§Ã£o de Chamadas de API Ofuscadas
function AdvancedDeobfuscationModule:DeobfuscateObfuscatedAPICalls(code)
    local changes = {}
    local deobfuscated = code
    local apiPattern = "([%w_]+)%.([%w_]+)%((.-)%)"
    deobfuscated = string.gsub(deobfuscated, apiPattern, function(obj, method, args)
        logChange(changes, "api_call_deobfuscation", string.format("%s.%s(%s)", obj, method, args), method)
        return string.format("%s(%s)", method, args)
    end)
    return deobfuscated, changes
end

-- 24. DesofuscaÃ§Ã£o de Loops de Controle Ofuscados
function AdvancedDeobfuscationModule:DeobfuscateControlLoops(code)
    local changes = {}
    -- Placeholder: Simplificar loops de controle complexos
    logChange(changes, "control_loop_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 25. DesofuscaÃ§Ã£o de PadrÃµes Baseados em Regex AvanÃ§ados
function AdvancedDeobfuscationModule:DeobfuscateAdvancedPatterns(code)
    local changes = {}
    local deobfuscated = code
    local advPattern = "([%w_]+)%s*=%s*function%([^)]*%)[^end]*end"
    deobfuscated = string.gsub(deobfuscated, advPattern, function(varName)
        logChange(changes, "advanced_pattern_deobfuscation", varName, "-- Simplified")
        return string.format("local %s = -- Deobfuscated function", varName)
    end)
    return deobfuscated, changes
end

-- 26. DesofuscaÃ§Ã£o de Camadas MÃºltiplas
function AdvancedDeobfuscationModule:DeobfuscateLayers(code)
    local changes = {}
    local deobfuscated = code
    for i = 1, self.Config.maxIterations do
        local result, stepChanges = self:Deobfuscate(code, {})
        if #stepChanges == 0 then break end
        deobfuscated = result.deobfuscated
        for _, change in ipairs(stepChanges) do
            table.insert(changes, change)
        end
    end
    return deobfuscated, changes
end

-- 27. DesencriptaÃ§Ã£o com Chave Derivada
function AdvancedDeobfuscationModule:DeobfuscateDerivedKey(code)
    local changes = {}
    -- Placeholder: Usar chaves derivadas do prÃ³prio cÃ³digo
    logChange(changes, "derived_key_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 28. DesofuscaÃ§Ã£o de CÃ³digo Concatenado
function AdvancedDeobfuscationModule:DeobfuscateConcatenatedCode(code)
    local changes = {}
    local deobfuscated = code
    local concatPattern = "local%s+([%w_]+)%s*=%s*(.-)%.%.(.-);"
    deobfuscated = string.gsub(deobfuscated, concatPattern, function(varName, part1, part2)
        local result = part1 .. part2
        logChange(changes, "concatenated_code_deobfuscation", part1 .. ".." .. part2, result)
        return string.format("local %s = %q", varName, result)
    end)
    return deobfuscated, changes
end

-- 29. DesofuscaÃ§Ã£o de VariÃ¡veis Globais Ofuscadas
function AdvancedDeobfuscationModule:DeobfuscateGlobalVariables(code)
    local changes = {}
    local deobfuscated = code
    local globalPattern = "_G%[['\"](.-)['\"]%]"
    deobfuscated = string.gsub(deobfuscated, globalPattern, function(key)
        logChange(changes, "global_variable_deobfuscation", key, key)
        return key
    end)
    return deobfuscated, changes
end

-- 30. DesencriptaÃ§Ã£o com Chave de SessÃ£o
function AdvancedDeobfuscationModule:DeobfuscateSessionKey(code)
    local changes = {}
    -- Placeholder: Desencriptar usando chaves de sessÃ£o temporÃ¡rias
    logChange(changes, "session_key_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 31. DesofuscaÃ§Ã£o de CÃ³digo Ofuscado por Eval
function AdvancedDeobfuscationModule:DeobfuscateEvalCode(code)
    local changes = {}
    -- Placeholder: Processar cÃ³digo executado via eval
    logChange(changes, "eval_code_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- 32. DesofuscaÃ§Ã£o de PadrÃµes de OfuscaÃ§Ã£o Personalizados
function AdvancedDeobfuscationModule:DeobfuscateCustomPatterns(code)
    local changes = {}
    -- Placeholder: Detectar e reverter padrÃµes personalizados
    logChange(changes, "custom_pattern_deobfuscation", code, code, { status = "placeholder" })
    return code, changes
end

-- FunÃ§Ã£o principal de desofuscaÃ§Ã£o
function AdvancedDeobfuscationModule:Deobfuscate(code, options)
    if not code or type(code) ~= "string" or #code == 0 then
        return nil, "CÃ³digo invÃ¡lido ou vazio"
    end
    if #code > self.Config.maxStringLength then
        return nil, "CÃ³digo muito grande (limite: " .. self.Config.maxStringLength .. ")"
    end

    if self.Config.useCryptoKeys and not LoadedKeys then
        self:InitializeCryptoKeys()
    end

    local originalConfig = {}
    if options then
        for key, value in pairs(options) do
            if self.Config[key] ~= nil then
                originalConfig[key] = self.Config[key]
                self.Config[key] = value
            end
        end
    end

    local deobfuscated = code
    local allChanges = {}
    local methods = {
        "DeobfuscateBytecode", "DeobfuscateBase64", "DeobfuscateEnvironments", "DeobfuscateTables",
        "DeobfuscateRobloxCrypt", "DeobfuscateFunctions", "DeobfuscateLZW", "DeobfuscateHuffman",
        "DeobfuscateAES", "DeobfuscateRSA", "DeobfuscateScrambledConstants", "DeobfuscateIndirectCalls",
        "DeobfuscateObfuscatedLoops", "DeobfuscateObfuscatedConditions", "DeobfuscateInjectedCode",
        "DeobfuscateRenamedVariables", "DeobfuscateRotatingKey", "DeobfuscateFragmentedStrings",
        "DeobfuscateDynamicTables", "DeobfuscateHashedValues", "DeobfuscateObfuscatedAPICalls",
        "DeobfuscateControlLoops", "DeobfuscateAdvancedPatterns", "DeobfuscateLayers",
        "DeobfuscateDerivedKey", "DeobfuscateConcatenatedCode", "DeobfuscateGlobalVariables",
        "DeobfuscateSessionKey", "DeobfuscateEvalCode", "DeobfuscateCustomPatterns"
    }

    for _, method in ipairs(methods) do
        local result, methodChanges = self[method](self, deobfuscated)
        deobfuscated = result
        for _, change in ipairs(methodChanges) do
            table.insert(allChanges, change)
        end
    end

    for key, value in pairs(originalConfig) do
        self.Config[key] = value
    end

    local result = {
        original = code,
        deobfuscated = deobfuscated,
        changes = allChanges,
        cryptoKeysUsed = LoadedKeys ~= nil,
        statistics = {
            originalSize = #code,
            deobfuscatedSize = #deobfuscated,
            changesCount = #allChanges,
            compressionRatio = math.floor((#deobfuscated / #code) * 100)
        },
        metadata = {
            processedAt = os.time(),
            moduleVersion = self.Info.Version
        }
    }
    return result, nil
end

-- FunÃ§Ã£o para obter informaÃ§Ãµes do mÃ³dulo
function AdvancedDeobfuscationModule:GetInfo()
    return self.Info
end

-- Log de inicializaÃ§Ã£o
if AdvancedDeobfuscationModule.Config.logChanges then
    print("ðŸ”“ AdvancedDeobfuscationModule v" .. AdvancedDeobfuscationModule.Info.Version .. " carregado!")
    print("ðŸ“‹ 32 MÃ©todos disponÃ­veis:")
    for i, method in ipairs({
        "DeobfuscateBytecode", "DeobfuscateBase64", "DeobfuscateEnvironments", "DeobfuscateTables",
        "DeobfuscateRobloxCrypt", "DeobfuscateFunctions", "DeobfuscateLZW", "DeobfuscateHuffman",
        "DeobfuscateAES", "DeobfuscateRSA", "DeobfuscateScrambledConstants", "DeobfuscateIndirectCalls",
        "DeobfuscateObfuscatedLoops", "DeobfuscateObfuscatedConditions", "DeobfuscateInjectedCode",
        "DeobfuscateRenamedVariables", "DeobfuscateRotatingKey", "DeobfuscateFragmentedStrings",
        "DeobfuscateDynamicTables", "DeobfuscateHashedValues", "DeobfuscateObfuscatedAPICalls",
        "DeobfuscateControlLoops", "DeobfuscateAdvancedPatterns", "DeobfuscateLayers",
        "DeobfuscateDerivedKey", "DeobfuscateConcatenatedCode", "DeobfuscateGlobalVariables",
        "DeobfuscateSessionKey", "DeobfuscateEvalCode", "DeobfuscateCustomPatterns",
        "ExtractCryptoKeys", "IncrementalDeobfuscation"
    }) do
        print(string.format("   %d. %s", i, method))
    end
    AdvancedDeobfuscationModule:InitializeCryptoKeys()
end

return AdvancedDeobfuscationModule
